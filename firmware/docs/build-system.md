# ESP-IDF Build System

This document explains how the firmware is built using ESP-IDF.

## Overview

ESP-IDF uses a Python-based build system that wraps CMake and Ninja. The main entry point is `idf.py`, which orchestrates compilation, flashing, and monitoring.

## Build Flow

```
idf.py build
    │
    ├─→ CMake         Configure project, generate build files
    │
    ├─→ Ninja         Compile C/C++ code using GCC toolchain
    │
    └─→ Output        Binary files in build/ directory
```

## Key Python Scripts

| Script | Location | Purpose |
|--------|----------|---------|
| `idf.py` | `$IDF_PATH/tools/idf.py` | Main CLI wrapper |
| `esptool.py` | `$IDF_PATH/components/esptool_py/esptool/` | Flash firmware to ESP32 |
| `idf_monitor.py` | `$IDF_PATH/tools/idf_monitor.py` | Serial monitor with crash decoding |

### idf.py

The main command-line interface. Routes commands to appropriate tools:

```bash
idf.py set-target esp32c3   # Configure for ESP32-C3
idf.py menuconfig           # Interactive configuration
idf.py build                # Compile firmware
idf.py flash                # Write to device
idf.py monitor              # Serial output
idf.py clean                # Remove build artifacts
idf.py fullclean            # Remove all generated files
```

### esptool.py

Handles communication with the ESP32 bootloader:
- Writes firmware binary to flash
- Can read/write flash contents
- Verifies flash after write

Called automatically by `idf.py flash`.

### idf_monitor.py

Enhanced serial monitor:
- Displays serial output from device
- Decodes crash stack traces to source file:line
- Supports GDB integration
- Keyboard shortcuts (Ctrl+] to exit)

## Build Configuration

### sdkconfig.defaults

Default options applied when configuring a new build:

```
CONFIG_IDF_TARGET="esp32c3"     # Target chip
CONFIG_ESP_WIFI_SSID=""          # WiFi credentials
CONFIG_FREERTOS_HZ=1000          # Tick rate
```

### sdkconfig

Full configuration file generated by CMake. Contains all options (defaults + menuconfig changes). This file is regenerated when you run `idf.py menuconfig`.

**Note**: Delete `sdkconfig` when changing target chips to force regeneration.

### CMakeLists.txt (main/)

Registers the main component with its source files and dependencies:

```cmake
idf_component_register(
    SRCS "main.c" "wifi.c" "temperature.c" ...
    INCLUDE_DIRS "."
    REQUIRES nvs_flash esp_wifi driver ...
)
```

## Toolchain

ESP-IDF installs the appropriate GCC toolchain:

| Target | Toolchain |
|--------|-----------|
| ESP32 | xtensa-esp32-elf-gcc |
| ESP32-S2 | xtensa-esp32s2-elf-gcc |
| ESP32-S3 | xtensa-esp32s3-elf-gcc |
| ESP32-C3 | riscv32-esp-elf-gcc |

The ESP32-C3 uses a RISC-V core, so it needs the RISC-V toolchain.

## Build Output

After `idf.py build`, the `build/` directory contains:

```
build/
├── bootloader/           # Second-stage bootloader
├── partition_table/      # Flash partition info
├── iot_crockpot.bin      # Main application binary
├── iot_crockpot.elf      # ELF with debug symbols
└── flash_args            # Arguments for esptool
```

## Common Issues

### "No such command" or "idf.py not found"

ESP-IDF environment not set up. Run:
- Windows: Open "ESP-IDF Command Prompt" from Start menu
- Linux/Mac: `source $IDF_PATH/export.sh`

### Build fails after changing target

Delete `sdkconfig` and rebuild:

```bash
rm sdkconfig
idf.py set-target esp32c3
idf.py build
```

### Flash fails with "Permission denied"

- Windows: Install USB drivers (CP210x or CH340 depending on board)
- Linux: Add user to dialout group: `sudo usermod -a -G dialout $USER`

## References

- [ESP-IDF Programming Guide](https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/)
- [ESP-IDF Build System](https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/api-guides/build-system.html)
- [esptool.py Documentation](https://docs.espressif.com/projects/esptool/en/latest/)
